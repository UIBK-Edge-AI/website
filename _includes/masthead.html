{% include base_path %}

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button class="hidden"><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg persist">
            <a href="https://www.uibk.ac.at/informatik/" target="_blank" rel="noopener noreferrer">
              <img 
                id="site-logo"
                src="{{ base_path }}/images/light.svg" 
                data-light="{{ base_path }}/images/light.svg"
                data-dark="{{ base_path }}/images/black.svg"
                alt="university_innsbruck_logo" 
                class="site-logo"
              >
            </a>
          </li>
          {% for link in site.data.navigation.main %}
            {% if link.dropdown %}
              <!-- Dropdown Navigation Item - ADD PERSIST CLASS HERE -->
              <li class="masthead__menu-item dropdown-item persist{% if page.url contains link.url %} active{% endif %}">
                <a href="{% if link.url contains 'http' %}{{ link.url }}{% else %}{{ base_path }}{{ link.url }}{% endif %}" class="dropdown-toggle">
                  {{ link.title }}
                  <i class="fa-solid fa-chevron-down dropdown-arrow" aria-hidden="true"></i>
                </a>
                <ul class="dropdown-menu">
                  {% for dropdown_item in link.dropdown_items %}
                    <li class="dropdown-menu-item">
                      <a href="{% if dropdown_item.url contains 'http' %}{{ dropdown_item.url }}{% else %}{{ base_path }}{{ dropdown_item.url }}{% endif %}" 
                         data-filter="{{ dropdown_item.filter }}"
                         onclick="handleDropdownNavigation('{{ dropdown_item.filter }}', event)">
                        {% if dropdown_item.icon %}
                          <span class="dropdown-icon">{{ dropdown_item.icon }}</span>
                        {% endif %}
                        {{ dropdown_item.title }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              </li>
            {% else %}
              <!-- Regular Navigation Item -->
              {% if link.url contains 'http' %}
                {% assign domain = '' %}
              {% else %}
                {% assign domain = base_path %}
              {% endif %}
              <li class="masthead__menu-item{% if page.url == link.url %} active{% endif %}">
                <a href="{{ domain }}{{ link.url }}">{{ link.title }}</a>
              </li>
            {% endif %}
          {% endfor %}
          <li id="theme-toggle" class="masthead__menu-item persist tail">
            <a><i id="theme-icon" class="fa-solid fa-sun" aria-hidden="true" title="toggle theme"></i></a>
          </li>
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

<script>
// Enhanced dropdown functionality with debugging
(function() {
  'use strict';

  function initializeDropdowns() {
    console.log('Initializing dropdowns...');
    const dropdownItems = document.querySelectorAll('.masthead__menu-item.dropdown-item');
    console.log('Found dropdown items:', dropdownItems.length);
    
    if (dropdownItems.length === 0) {
      console.warn('No dropdown items found! Check if HTML structure is correct.');
      return;
    }
    
    dropdownItems.forEach(function(item, index) {
      const toggle = item.querySelector('.dropdown-toggle');
      const dropdown = item.querySelector('.dropdown-menu');
      
      console.log(`Dropdown ${index}:`, {
        item: item,
        toggle: toggle,
        dropdown: dropdown,
        hasPersistClass: item.classList.contains('persist')
      });
      
      if (toggle && dropdown) {
        let hoverTimeout;

        // Add debugging classes
        item.setAttribute('data-dropdown-initialized', 'true');

        // Show dropdown on mouseenter
        item.addEventListener('mouseenter', function(e) {
          console.log('Mouse enter on dropdown', index);
          clearTimeout(hoverTimeout);
          
          // Close other dropdowns
          dropdownItems.forEach(function(otherItem) {
            if (otherItem !== item) {
              otherItem.classList.remove('open');
            }
          });
          
          // Open current dropdown
          item.classList.add('open');
          console.log('Added open class to dropdown', index);
        });
        
        // Hide dropdown on mouseleave with slight delay
        item.addEventListener('mouseleave', function(e) {
          console.log('Mouse leave on dropdown', index);
          hoverTimeout = setTimeout(function() {
            item.classList.remove('open');
            console.log('Removed open class from dropdown', index);
          }, 300);
        });

        // Keep dropdown open when hovering over dropdown menu
        dropdown.addEventListener('mouseenter', function(e) {
          console.log('Mouse enter on dropdown menu', index);
          clearTimeout(hoverTimeout);
          item.classList.add('open');
        });

        dropdown.addEventListener('mouseleave', function(e) {
          console.log('Mouse leave on dropdown menu', index);
          hoverTimeout = setTimeout(function() {
            item.classList.remove('open');
          }, 300);
        });

        console.log(`Dropdown ${index} initialized successfully`);
      } else {
        console.warn(`Dropdown ${index} missing elements:`, {
          hasToggle: !!toggle,
          hasDropdown: !!dropdown
        });
      }
    });
  }

  // Handle dropdown navigation with filtering
  window.handleDropdownNavigation = function(filter, event) {
    console.log('Handling dropdown navigation:', filter);
    if (window.location.pathname.includes('/research/')) {
      event.preventDefault();
      
      if (window.researchFilter) {
        window.researchFilter.filterByCategory(filter);
      }
      
      // Close dropdown
      document.querySelectorAll('.dropdown-item').forEach(function(item) {
        item.classList.remove('open');
      });
      
      const newUrl = `/research/${filter !== 'all' ? '?filter=' + filter : ''}`;
      window.history.pushState({filter: filter}, '', newUrl);
      
      return false;
    }
  };

  // Initialize when DOM is ready
  console.log('DOM ready state:', document.readyState);
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded');
      setTimeout(function() {
        initializeDropdowns();
      }, 500); // Increased delay to let greedy nav settle
    });
  } else {
    console.log('DOM already ready, initializing immediately');
    setTimeout(function() {
      initializeDropdowns();
    }, 500);
  }

  // Also try initializing after window load as fallback
  window.addEventListener('load', function() {
    console.log('Window loaded, re-initializing dropdowns as fallback');
    setTimeout(function() {
      initializeDropdowns();
    }, 1000);
  });

})();
</script>